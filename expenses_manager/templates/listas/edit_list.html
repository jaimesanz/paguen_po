{% extends "base.html" %}
{% load bootstrap3 %}
{% load crispy_forms_tags %}

{% block custom_head %}
    {% include "general/datatables.html" %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <script src="https://raw.githubusercontent.com/select2/select2/master/dist/js/i18n/es.js"></script>
{% endblock %}

{% block content_title %}{{ request.user.get_vivienda }}{% endblock %}

{% block subtitle %}
    Editar Lista
{% endblock %}

{% block buttons %}
    {% bootstrap_button "Agregar Ítem" icon="plus" name="add_more" button_class="btn-warning" %}
    <hr>
{% endblock %}

{% block help_info_button %}
{% endblock %}

{% block content %}
    <form action="." method="post">
        {% csrf_token %}
        {{ formset.management_form }}
        <div id="form_set">
            <table id="items_lista" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Ítem</th>
                        <th>Cantidad</th>
                        <th>Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset.forms %}
                        <tr>
                            <td>
                                {% bootstrap_field form.item show_label=False %}
                            </td>
                            <td>
                                {% bootstrap_field form.cantidad_solicitada show_label=False %}
                            </td>
                            <td>
                                {% bootstrap_field form.DELETE show_label=False %}
                                {% bootstrap_field form.id %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <br>
        <button id="create_list_btn" type="submit" class="btn btn-primary"
                style="float: right;">
            {% bootstrap_icon "ok" %} Guardar Cambios
        </button>
    </form>
    {% bootstrap_button "Guardar Cambios" icon="ok" name="confirmSubmit" button_class="btn-primary" as confirm_button %}
    {% include "general/modal.html" with modal_id="ConfirmModal" modal_title="Confirme los datos" modal_body="<p>Revise que los datos ingresados estén correctos antes de guardar la lista. <strong>Recuerde que no puede repetir ítems en la lista.</strong></p>"|add:confirm_button  %}

    <div id="empty_form_item" style="display:none">
        {% bootstrap_field formset.empty_form.item show_label=False %}
    </div>
    <div id="empty_form_qty" style="display:none">
        {% bootstrap_field formset.empty_form.cantidad_solicitada show_label=False %}
    </div>
    <div id="empty_form_delete" style="display:none">
        {% bootstrap_field formset.empty_form.DELETE show_label=False %}
        {% bootstrap_field formset.empty_form.id %}
    </div>
    <script type="text/javascript">
        $(document).ready(function () {

            $("#create_list_btn").click(function () {
                $("#ConfirmModal").modal();
                return false;
            });
            $("button[name='confirmSubmit']").click(function () {
                $("form").submit();
            });

            var item_selects = $('#items_lista select');
            item_selects.attr("style", "width: 100%");
            item_selects.select2({
                language: "es",
                placeholder: "Ítem",
                theme: "classic"
            });

            var items_lista = $('#items_lista').DataTable({
                paging: false,
                filter: false,
                bSort: false,
                bInfo:false
            });

            // source: http://stackoverflow.com/a/8097617
            $('button[name="add_more"]').click(function() {
                var form_idx = $('#id_itemlista_set-TOTAL_FORMS').val();
                item_input = $('#empty_form_item').html().replace(/__prefix__/g, form_idx);
                qty_input = $('#empty_form_qty').html().replace(/__prefix__/g, form_idx);
                delete_input = $('#empty_form_delete').html().replace(/__prefix__/g,form_idx);
                items_lista.row.add(
                        [
                            item_input,
                            qty_input,
                            delete_input]
                ).draw();
                var this_select = $("#id_itemlista_set-" + form_idx + "-item");
                this_select.attr("style", "width: 100%");
                this_select.select2({
                    language: "es",
                    placeholder: "Ítem",
                    theme: "classic"
                });
                $('#id_itemlista_set-TOTAL_FORMS').val(parseInt(form_idx) + 1);
            });
        });
    </script>
{% endblock %}

{% block help_info_modal %}
{% endblock %}