{% extends "base.html" %}
{% load bootstrap3 %}

{% block custom_head %}
	{% include "general/datatables.html" %}
{% endblock %}

{% block content_title %}{{vivienda_usuario.vivienda}}{% endblock %}

{% block subtitle %}
    Listas
{% endblock %}

{% block content %}
	<!-- Nav tabs -->
	<ul class="nav nav-tabs" role="tablist">
		<li role="presentation" class="active"><a href="#nueva_lista" aria-controls="nueva_lista" role="tab" data-toggle="tab">Nueva Lista</a></li>
		<li role="presentation"><a href="#pendientes" aria-controls="pendientes" role="tab" data-toggle="tab">Pendientes</a></li>
	</ul>
	<br>

	<!-- Tab panes -->
	<div class="tab-content">
		<!-- nueva lista -->
		<div role="tabpanel" class="tab-pane active" id="nueva_lista">
			<form action="/nueva_lista/" method="POST" id="nueva_lista_form">
				<input type="hidden" name="max_item_index" id="max_item_index"></input>
				{% csrf_token %}
				<table id="items_lista" class="table table-striped table-bordered" cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>Ítem</th>
							<th>Cantidad</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								<button type="button" id="add_item" class="btn btn-warning">
									{% bootstrap_icon "plus" %} Agregar ítem
								</button>
							</td>
							<td></td>
							<td></td>
						</tr>
					</tbody>
				</table>
				<br>
				<button type="submit" class="btn btn-primary" style="float: right;">
					{% bootstrap_icon "ok" %} Generar lista
				</button>
				<br><br>
				<div id="nueva_lista_form_dyn"></div>
				<!-- TODO put each tab ina  diferent page. This way the user doesn't have to load the whole set of lists when the only thing he wanted was to create a new one -->
			</form>
		</div>

		<!-- pendientes -->
		<div role="tabpanel" class="tab-pane" id="pendientes">
			<table id="tabla_listas_pendientes" class="table table-striped table-bordered" cellspacing="0" width="100%">
				<thead>
					<tr>
						<th>Fecha</th>
						<th>Ítems</th>
						<th>Creada por</th>
					</tr>
				</thead>
				<tbody>
					{% for lista in listas_pendientes %}
					<tr>
						<td><a href="/detalle_lista/{{lista.id}}"><span class="glyphicon glyphicon-log-in" aria-hidden="true"></span></a> {{lista.fecha}}</td>
						<td>{{lista.count_items}}</td>
						<td>{{lista.usuario_creacion.user}}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>


	<script type="text/javascript">
		var input_number = 1
		var items_measure = {};
		$(document).ready(function(){
			// TODO customize tables. Currently using the default parameter-less dataTable
			$('#tabla_listas_pendientes').DataTable({
				paging: false,
				filter: false
			});
			var items_lista = $('#items_lista').DataTable({
				paging: false,
				filter: false,
				bSort: false,
				bInfo:false
			});
			$('#add_item').click(function(){
				this_item_number = input_number++;
				$("#max_item_index").val(this_item_number);
				this_item_input_id = "item_"+ this_item_number
				// create inputs
				item = $("<input>")
					.attr("type", "text")
					.attr("value", "")
					.attr("id", this_item_input_id)
					.attr("name", "item_"+ this_item_number)
					.attr("placeholder", "Ítem")
					.attr("class","form-control");
				quantity = $("<input>")
					.attr("type", "number")
					.attr("value", "")
					.attr("name", "quantity_" + this_item_number)
					.attr("id", this_item_input_id + "_qty")
					.attr("placeholder", "Cantidad")
					.attr("class","form-control");
				
				// create an input group for each column
				first_col_input_group = $("<div>").attr("class","input-group").append(item);
				second_col_input_group = $("<div>").attr("class","input-group").append(quantity);

				// delete button for the row
				var delete_button = $("<button>")
										.attr("type", "button")
										.attr("class", "btn btn-danger")
										.attr("id", this_item_input_id + "_delete")
										.append($("<span>")
													.attr("class", "glyphicon glyphicon-trash")
													.attr("aria-hidden", "true"));

				// update table
				var first_content = $("<div>").append(first_col_input_group).html();
				var second_content = $("<div>").append(second_col_input_group).html();
				var delete_button_content = $("<div>").append(delete_button).html()
				items_lista.row.add([first_content,second_content,delete_button_content]).draw();
				// make the button functional
				$("#" + this_item_input_id + "_delete").click(function(){
					items_lista.row($(this).parent().parent("tr")).remove().draw();
				})

				$("#"+this_item_input_id).autocomplete({
					autoFocus: true,
					source: function(request, response){
						$.ajax({
							url:"/get_items_autocomplete/",
							data: {term: request.term},
							dataType: "json",
							success: function( data ) {
								response( $.map( data, function( item ) {
									items_measure[item[0]] = item[1]
									return {
										label: item[0],
										value: item[0]
									}
								}));
							}
						});
					},
					select: function(){
						qty_id = "#" + $(this).attr("id") + "_qty";
						unidad_medida = items_measure[$(this).val()];
						$(qty_id).attr("placeholder", unidad_medida).val("");
					},
					change: function (ev, ui) {
						if (!ui.item)
							$(this).val("");
					},
				})
			});
		} );
	</script>
{% endblock %}