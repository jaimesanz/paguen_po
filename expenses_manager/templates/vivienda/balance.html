{% extends "base.html" %}
{% load bootstrap3 %}
{% load static %}
{% load humanize %}

{% block custom_head %}
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.1/Chart.min.js"></script>
	<script type="text/javascript" src="{% static 'js/period_functions.js' %}"></script>
{% endblock %}


{% block content_title %}{{vivienda}}{% endblock %}

{% block subtitle %}
    Balance de Gastos
{% endblock %}

{% block buttons %}
    {% bootstrap_button "Transferir" icon="share-alt" name="transfer_button" button_class="btn-warning" %}
    {% bootstrap_button "¿Cómo balancear?" icon="transfer" name="instructions_button" button_class="btn-success" %}
{% endblock %}

{% block content %}
	<div id="transfer_modal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Transferir Monto a otro Ususario</h4>
				</div>
				<div class="modal-body">
					<form method="post" action="/transfer/">
					  {% csrf_token %}
					  {% bootstrap_form form %}
					  {% bootstrap_button "Transferir" button_type="submit" button_class="btn-primary" %}
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>
    <div id="instructions_div" style="display: none">
        {% if instructions %}
            <p>Para balancear los gastos de todos los usuarios, se deben seguir
            estas instrucciones:</p>
            <ul>
            {% for vu, transfers in instructions.items %}
                <li> {{ vu.user }} debe transferir: </li>
                <ul>
                    {% for t in transfers %}
                        <li>
                            ${{ t.1 | floatformat:"0" | intcomma }} a {{ t.0.user }}
                        </li>
                    {% endfor %}
                </ul>
            {% endfor %}
            </ul>
        {% else %}
            <p>Los usuarios ya se encuentran balanceados.</p>
        {% endif %}
        <hr>
    </div>

	<canvas id="user_expenses_chart"></canvas>

	<script type="text/javascript">
		$(document).ready(function(){
            $("button[name=instructions_button]").click(function() {
                $("#instructions_div").toggle()
            })
			$("button[name=transfer_button]").click(function(){
				transfer_modal = $("#transfer_modal");
				transfer_modal.modal("toggle");
			});
			$.format.locale({
			    number: {
			        groupingSeparator: '.',
			        decimalSeparator: ','
			    }
			});

			var ctx = $("#user_expenses_chart").get(0).getContext("2d");
			labels = []
			values = []
			var myChart = null
			{% for vivienda_usuario, total in users_disbalance.items %}
				labels.push("{{vivienda_usuario.user}}");
				values.push(parseInt("{{total}}"));
			{% endfor %}

			color_list = getRandomColorAsList()
            color = getTransparentColor(color_list, 0.2)
            border_color = getTransparentColor(color_list, 1)
            hover_color = getTransparentColor(color_list, 0.4)
			var data = {
			    labels: labels,
			    datasets: [
			        {
			            label: "Balance de Gastos",
                        backgroundColor: color,
                        borderColor: border_color,
                        borderWidth: 1,
                        hoverBackgroundColor: hover_color,
                        hoverBorderColor: border_color,
			            data: values
			        }
			    ]
			};
			var options = {
                responsive: true,
                responsiveAnimationDuration: 1000,
				tooltips: {
                    enabled: true,
                    mode: 'single',
                    callbacks: {
                        label: function(tooltipItems, data) {
                            return '$ ' + $.format.number(tooltipItems.yLabel,
                                            '#,##0.#');
                        }
                    }
                },
                scales: {
                    yAxes: [{
                        display: true,
                        ticks: {
                            suggestedMax: Math.max.apply(Math, values)*1.05,
                            suggestedMin: Math.min.apply(Math, values)*1.05
                        }
                    }]
                }
			};

			myChart = new Chart(ctx, {
                type:'bar',
                data: data,
                options: options
            });
		});
	</script>
{% endblock %}

{% block info_title %}
    Sobre los balances
{% endblock %}

{% block info_content %}
    En esta página puede ver de forma gráfica qué tan desbalanceados se
    encuentran las contribuciones a la Vivienda por parte de cada usuario.
    <br><br>
    Para computar este balance, se toman en cuenta las siguientes
    consideraciones:
    <br><br>
    <ul>
        <li>Los Gastos sólo se cuentan para los usuarios que pertenecían a la
            Vivienda el día que se realizó el Gasto.
        </li>
        <br>
        <li>Sólo se consideran Gastos cuya categoría esta marcada como
            <i>compartida</i>.
        </li>
        <br>
        <li>Los Gastos cuya categoría, además de ser compartida, es también
            <i>compartida en vacaciones</i> se cuentan para todos los usuarios.
        </li>
        <br>
        <li>Los Gastos cuya categoría esta marcada como <b>no
            compartida en vacaciones</b> sólo se cuentan para los usuarios
            que <b>no</b> estaban de vacaciones al momento de realizar el
            Gasto, <b>independiente de cuántos días se encontraban afuera los
            usuarios de vacaciones</b>.
        </li>
    </ul>
    Debido a estos motivos, se recomienda hacer los ajustes necesarios en
    <a href="/vivienda/categorias/" target="_blank">categorías</a> antes de
    llevar a cabo el balance.
    <br><br>
    Luego de realizar el balance fuera del sistema, es necesario que se
    ingresen las transferencias realizadas haciendo click en "Transferir", de
    tal forma que el sistema entienda que efectivamente se llevó a cabo el
    balance, y pueda seguir llevando el balance de forma correcta.
    <br><br>
    <b>Notar que si se llega a un balance distinto al que indica el sistema,
        de todas formas se sugiere que, en el sistema, se ingresen las
        transacciones indicadas, de tal forma que el sistema vea que estan
        balanceados, y el gráfico de balance sea coherente con la realidad de
        la vivienda.</b>
{% endblock %}