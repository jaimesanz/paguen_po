{% extends "base.html" %}
{% load bootstrap3 %}

{% block custom_head %}
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.1/Chart.min.js"></script>
	<style type="text/css">
		.canvas_label {
			width: 50%;
			margin: 0 auto;
		}
	</style>
{% endblock %}

{% block content_title %}{{request.user.get_vivienda}}{% endblock %}

{% block subtitle %}
    Presupuestos {{year}}-{{month}}
{% endblock %}

{% block buttons %}
    <a href="/graphs/presupuestos/{{prev_year}}/{{prev_month}}" class="btn btn-primary" role="button">
        {% bootstrap_icon "chevron-left" %} Anterior
    </a>
    <a href="/graphs/presupuestos/{{next_year}}/{{next_month}}" class="btn btn-primary" role="button">
        Siguiente {% bootstrap_icon "chevron-right" %}
    </a>
    <a href="/presupuestos/{{year}}/{{month}}" class="btn btn-primary" role="button">
        {% bootstrap_icon "th-list" %} Resumen
    </a>
    <a href="/presupuestos/new/" class="btn btn-warning" role="button">
        {% bootstrap_icon "plus" %} Nuevo
    </a>
{% endblock %}

{% block content %}
	<div class="row">
		{% for p in presupuestos %}
			<div class="col-sm-4">
				<h4 class="canvas_label"><a href="/presupuestos/{{p.year_month.year}}/{{p.year_month.month}}/{{p.categoria}}">{{p.categoria}}</a></h4>
				<canvas id="{{p.id}}_Chart"></canvas>
			</div>
			{% if forloop.counter|divisibleby:3 %}
				<!-- add new row -->
				</div>
				<hr>
				<div class="row">
			{% endif %}
		{% empty %}
			<p>No hay presupuestos definidos para este período</p>
		{% endfor %}
	</div>


	<script type="text/javascript">
		$(document).ready(function(){
			var is_mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)
			$.format.locale({
			    number: {
			        groupingSeparator: '.',
			        decimalSeparator: ','
			    }
			});

			{% for p in presupuestos %}
				var ctx = $("#{{p.id}}_Chart").get(0).getContext("2d");
				presupuesto = parseInt("{{p.monto}}");
				invertido = parseInt("{{p.get_total_expenses}}");
				restante = presupuesto - invertido;
				invertido_color = "808080";
				invertido_highlight = "575252";
				invertido_label = "Invertido";
				presupuesto_pretty = "$" + $.format.number(presupuesto, '#,' +
                                '##0.#');

                var labels = [
                        invertido_label,
                        "Restante"
                ];

                var datasets = [
                        {
                            data: [invertido, restante],
                            backgroundColor: [
                                "#" + invertido_color,
                                "#66FF66"
                            ],
                            hoverBackgroundColor: [
                                "#" + invertido_highlight,
                                "#50DC50"
                            ]
                        }
                ];

				if(restante<=0){
                    invertido_color = "763939";
                    invertido_highlight = "763939";
                    invertido_label = "Presupuesto de " + presupuesto_pretty + " " +
                            "superado!"
                    labels = [
                            invertido_label
                    ];
                    datasets = [
                            {
                                data: [invertido],
                                backgroundColor: [
                                    "#" + invertido_color
                                ],
                                hoverBackgroundColor: [
                                    "#" + invertido_highlight
                                ]
                            }
                    ];
				}
                var data = {
                    labels: labels,
                    datasets: datasets
                };
				// TODO this is awesome but completely unnecessary and should never get to production
				random_number=Math.random()

                var options = {
                    responsive: true,
                    animation:{
                        animateRotate : random_number<0.66 && !is_mobile,
                        animateScale : random_number>0.33 && !is_mobile
                    },
                    tooltips: {
                        enabled: true,
                        mode: 'single',
                        callbacks: {
                            label: function(tooltipItems, data) {
                                index = tooltipItems.index;
                                dataset_index  =tooltipItems.datasetIndex;
                                amount = data.datasets[dataset_index]
                                        .data[index];
                                return '$ ' + $.format.number(amount,
                                                '#,##0.#');
                            }
                        }
                    }
                };

				var myDoughnutChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options:options
                });
			{% endfor %}
		});
	</script>

{% endblock %}

{% block info_title %}
    Graficando los Presupuestos
{% endblock %}

{% block info_content %}
    En esta página puede ver de forma gráfica los presupuesto definidos para
    este período.
    <br><br>
    Las áreas grises corresponden a cuánto se ha invertido en
    esa categoría en este período, mientras que las áreas verdes muestran
    cuánto margen queda antes de completar el presupuesto.
    <br><br>
    Un círculo rojizo indica que el presupuesto fue superado, y por lo tanto
    no queda margen.
    <br><br>
    Puede avanzar o retroceder a o otro período utilizando los botónes
    "Anterior" y "Siguiente", o crear uno nuevo con el botón "Nuevo". El
    botón "Resumen" le mostrará la misma información, pero en formato de tablas.
{% endblock %}