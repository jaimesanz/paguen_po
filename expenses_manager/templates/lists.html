{% extends "base.html" %}
{% load bootstrap3 %}

{% block custom_head %}
	{% include "datatables.html" %}
{% endblock %}

{% block content_title %}{{vivienda_usuario.vivienda}}{% endblock %}
{% block content %}

	<h3>Listas</h3>
	<!-- Nav tabs -->
	<ul class="nav nav-tabs" role="tablist">
		<li role="presentation" class="active"><a href="#nueva_lista" aria-controls="nueva_lista" role="tab" data-toggle="tab">Nueva Lista</a></li>
		<li role="presentation"><a href="#pendientes" aria-controls="pendientes" role="tab" data-toggle="tab">Pendientes</a></li>
	</ul>
	<br>

	<!-- Tab panes -->
	<div class="tab-content">
		<!-- nueva lista -->
		<div role="tabpanel" class="tab-pane active" id="nueva_lista">
			<form action="/nueva_lista/" method="POST" id="nueva_lista_form">
				{% csrf_token %}
				<button type="button" id="add_item" class="btn btn-warning">
					{% bootstrap_icon "plus" %} Agregar ítem
				</button>
				<button type="submit" class="btn btn-primary">
					{% bootstrap_icon "ok" %} Generar lista
				</button>
				<br>
				<br>
				<table id="items_lista" class="table table-striped table-bordered" cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>Ítem</th>
							<th>Cantidad</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<br><br>
				<div id="nueva_lista_form_dyn"></div>
				<!-- TODO add ajax (?????) autocomplete to input fields OOOOR put each tab ina  diferent page. This way the user doesn't have to load the whole set of lists when the only thing he wanted was to create a new one -->
			</form>
		</div>

		<!-- pendientes -->
		<div role="tabpanel" class="tab-pane" id="pendientes">
			<table id="tabla_listas_pendientes" class="table table-striped table-bordered" cellspacing="0" width="100%">
				<thead>
					<tr>
						<th>Fecha</th>
						<th>Ítems</th>
						<th>Creada por</th>
					</tr>
				</thead>
				<tbody>
					{% for lista in listas_pendientes %}
					<tr>
						<td><a href="/detalle_lista/{{lista.id}}"><span class="glyphicon glyphicon-log-in" aria-hidden="true"></span></a> {{lista.fecha}}</td>
						<td>{{lista.count_items}}</td>
						<td>{{lista.usuario_creacion.user}}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>


	<script type="text/javascript">
		var input_number = 1
		var items = [];
		var items_measure = {};
		{% for i in items %}
			items.push("{{i.nombre}}");
			items_measure["{{i.nombre}}"] = "{{i.unidad_medida}}"
		{% endfor %}
		$(document).ready(function(){
			// TODO customize tables. Currently using the default parameter-less dataTable
			$('#tabla_listas_pendientes').DataTable({
				paging: false,
				filter: false
			});
			var items_lista = $('#items_lista').DataTable({
				paging: false,
				filter: false
			});
			$('#add_item').click(function(){
				this_item_number = input_number++;
				this_item_input_id = "item_"+ this_item_number
				// create inputs
				item = $("<input>")
					.attr("type", "text")
					.attr("value", "")
					.attr("id", this_item_input_id)
					.attr("name", "item_"+ this_item_number)
					.attr("placeholder", "Ítem")
					.attr("class","form-control");
				quantity = $("<input>")
					.attr("type", "number")
					.attr("value", "")
					.attr("name", "quantity_" + this_item_number)
					.attr("id", this_item_input_id + "_qty")
					.attr("placeholder", "Cantidad")
					.attr("class","form-control");
				
				// create an input group for each column
				first_col_input_group = $("<div>").attr("class","input-group").append(item);
				second_col_input_group = $("<div>").attr("class","input-group").append(quantity);

				// update table
				var first_content = $("<div>").append(first_col_input_group).html();
				var second_content = $("<div>").append(second_col_input_group).html();
				items_lista.row.add([first_content,second_content]).draw();

				$("#"+this_item_input_id).autocomplete({
					source: items,
					select: function(){
						qty_id = "#" + $(this).attr("id") + "_qty";
						unidad_medida = items_measure[$(this).val()];
						$(qty_id).attr("placeholder", unidad_medida);
					},
					change: function (ev, ui) {
						if (!ui.item)
							$(this).val("");
					}
				})
			});
		} );
	</script>
{% endblock %}